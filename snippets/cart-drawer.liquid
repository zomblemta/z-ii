{% comment %}
  Renders cart drawer

  Usage:
  {% render 'cart-drawer' %}
{% endcomment %}

<script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>

<style>
  .drawer {
    visibility: hidden;
  }

  .drawer.active {
    visibility: visible;
  }

  #CartDrawer-Overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 998;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .drawer.active #CartDrawer-Overlay {
    opacity: 1;
    pointer-events: auto;
  }

  .cart-drawer__container {
    position: fixed !important;
    top: 0 !important;
    right: -100% !important;
    width: 100% !important;
    height: 100% !important;
    background: white !important;
    z-index: 999 !important;
    transition: right 0.3s ease !important;
    transform: none !important;
    border: none !important;
    padding: 0 !important;
    max-width: 100% !important;
  }

  @media (min-width: 768px) {
    .cart-drawer__container {
      width: 720px !important;
    }
  }

  .drawer.active .cart-drawer__container {
    right: 0 !important;
  }

  .cart-success-message {
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Override old cart drawer styles */
  .cart-drawer .cart-item {
    display: flex !important;
    grid-template: none !important;
  }

  cart-drawer-items {
    overflow: visible !important;
    flex: none !important;
  }

  .cart-drawer .cart-items thead,
  .cart-drawer thead {
    display: none !important;
  }

  .cart-drawer .drawer__cart-items-wrapper {
    flex-grow: 0 !important;
  }

  .cart-drawer .cart-items,
  .cart-drawer tbody {
    display: block !important;
  }

  /* Ensure Tailwind utility classes work */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>

<cart-drawer class="drawer{% if cart == empty %} is-empty{% endif %}">
  <div id="CartDrawer" class="cart-drawer">
    <div id="CartDrawer-Overlay" onclick="this.closest('cart-drawer').close()"></div>
    <div
      class="cart-drawer__container flex flex-col"
      role="dialog"
      aria-modal="true"
      aria-label="{{ 'sections.cart.title' | t }}"
      tabindex="-1"
    >
      <!-- Header -->
      <div class="flex items-center justify-between px-[20px] py-5 ">
        <div class="flex items-center justify-between border-b border-gray-200 w-full">
          <h2 class="text-[20px] font-Montaga font-normal tracking-wide ">YOUR CART</h2>
          <button
            class="w-6 h-6 flex items-center justify-center hover:opacity-70 transition-opacity"
            type="button"
            onclick="this.closest('cart-drawer').close()"
            aria-label="{{ 'accessibility.close' | t }}"
          >
            {% render 'icon', icon: 'icon-menu-close' %}
          </button>
        </div>
      </div>

      {%- if cart == empty -%}
        <div class="flex-1 flex flex-col items-center justify-center px-6 py-12">
          <h2 class="text-lg mb-6">{{ 'sections.cart.empty' | t }}</h2>
          <a
            href="{{ routes.all_products_collection_url }}"
            class="bg-gray-200 text-black px-8 py-3 hover:bg-gray-300 transition-colors text-sm tracking-wide"
          >
            {{ 'general.continue_shopping' | t }}
          </a>
        </div>
      {%- endif -%}
      <cart-drawer-items
        {% if cart == empty %}
          class="is-empty"
        {% endif %}
      >
        <form
          action="{{ routes.cart_url }}"
          id="CartDrawer-Form"
          class="flex-1 flex flex-col"
          method="post"
        >
          <div id="CartDrawer-CartItems" class="flex-1 overflow-y-auto">
            {%- if cart != empty -%}
              <!-- Success Message -->
              <div
                id="cart-success-message"
                class="cart-success-message bg-black text-white rounded-[5px] my-[20px] mx-[20px] px-6 py-4 text-center hidden"
              >
                <p class="text-sm">The product has been added to your cart !</p>
              </div>

              <!-- Cart Items -->
              <div class="px-[20px] py-4 space-y-6">
                {%- for item in cart.items -%}
                  <div
                    id="CartDrawer-Item-{{ item.index | plus: 1 }}"
                    class="flex flex-col md:flex-row justify-between md:bg-[#F4F4F4] rounded-[5px] gap-4  md:pr-[14px]"
                  >
                    <div class="flex items-center justify-between gap-[20px]">
                      <!-- Product Image -->
                      <div class="w-[160px] h-[160px] overflow-hidden rounded-[5px]  ">
                        {% if item.image %}
                          <a href="{{ item.url }}">
                            <img
                              class="w-full h-full object-cover"
                              src="{{ item.image | image_url: width: 300 }}"
                              alt="{{ item.image.alt | escape }}"
                              loading="lazy"
                              width="150"
                              height="{{ 150 | divided_by: item.image.aspect_ratio | ceil }}"
                            >
                          </a>
                        {% endif %}
                      </div>

                      <!-- Product Details -->
                      <div class="flex-1 flex flex-col justify-between min-w-0 h-[160px]">
                        <!-- Product Title -->
                        <div class="w-[142px] md:w-auto flex flex-col justify-between h-full md:py-[14px]">
                          <a
                            href="{{ item.url }}"
                            class="text-base font-normal  font-Montaga hover:opacity-70 transition-opacity block "
                          >
                            {{- item.product.title | escape -}}
                          </a>

                          <!-- Product Options (Color, Size, etc) -->
                          {%- if item.product.has_only_default_variant == false -%}
                            {%- for option in item.options_with_values -%}
                              <div class="flex items-center gap-2 ">
                                {%- if option.name == 'Color' or option.name == '颜色' -%}
                                  <span class="w-3 h-3 rounded-full bg-black border border-gray-300"></span>
                                  <span class="text-sm">{{ option.value }}</span>
                                {%- else -%}
                                  <span class="text-sm text-gray-600">{{ option.name }}: {{ option.value }}</span>
                                {%- endif -%}
                              </div>
                            {%- endfor -%}
                          {%- endif -%}

                          <!-- Lead Time -->
                          <div class="">
                            <p class="text-xs text-gray-400 ">Lead time:</p>
                            <div class="flex items-center gap-1">
                              <p class="text-[10px] text-black ">Approx. 12-18 business days</p>
                              <span class="flex items-center justify-center h-[14px] w-[14px] rounded-full bg-[#BABABA] text-white text-[10px]"
                                >?</span
                              >
                            </div>
                          </div>
                        </div>

                        <!-- Error Message -->
                        <div
                          id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}"
                          class="hidden text-xs text-red-600 mt-2"
                          role="alert"
                        >
                          <small class="cart-item__error-text"></small>
                        </div>
                      </div>
                    </div>

                    <!-- Quantity Controls and Price -->
                    <div class="flex md:flex-col items-center justify-between md:py-[14px] md:items-end">
                      <!-- Quantity Controls -->
                      <div class="flex items-center gap-3">
                        <quantity-input class="flex items-center bg-[#F5F5F5] md:bg-white rounded-[5px]">
                          <button
                            class="w-8 h-8 flex items-center justify-center hover:bg-gray-50 transition-colors"
                            name="minus"
                            type="button"
                            onclick="this.nextElementSibling.stepDown(); this.nextElementSibling.dispatchEvent(new Event('change', { bubbles: true }))"
                          >
                            <span class="text-sm">−</span>
                          </button>
                          <input
                            class="w-12 h-8 text-center text-sm focus:outline-none"
                            type="number"
                            data-quantity-variant-id="{{ item.variant.id }}"
                            name="updates[]"
                            value="{{ item.quantity }}"
                            data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                            min="0"
                            data-min="{{ item.variant.quantity_rule.min }}"
                            {% if item.variant.quantity_rule.max != null %}
                              max="{{ item.variant.quantity_rule.max }}"
                            {% endif %}
                            step="{{ item.variant.quantity_rule.increment }}"
                            aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                            id="Drawer-quantity-{{ item.index | plus: 1 }}"
                            data-index="{{ item.index | plus: 1 }}"
                          >
                          <button
                            class="w-8 h-8 flex items-center justify-center hover:bg-gray-50 transition-colors"
                            name="plus"
                            type="button"
                            onclick="this.previousElementSibling.stepUp(); this.previousElementSibling.dispatchEvent(new Event('change', { bubbles: true }))"
                          >
                            <span class="text-sm">+</span>
                          </button>
                        </quantity-input>

                        <!-- Remove Button -->
                        <cart-remove-button
                          id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
                          data-index="{{ item.index | plus: 1 }}"
                        >
                          <button
                            type="button"
                            class="w-6 h-6 md:w-[32px] md:h-[32px] flex items-center justify-center bg-[#F5F5F5] md:bg-white rounded-[5px] hover:opacity-70 transition-opacity"
                            aria-label="{{ 'sections.cart.remove_title' | t: title: item.title | escape }}"
                            data-variant-id="{{ item.variant.id }}"
                          >
                          {% render 'icon', icon: 'icon-remove' %}
                          </button>
                        </cart-remove-button>
                      </div>

                      <!-- Price -->
                      <div class="text-right">
                        {%- if item.original_line_price != item.final_line_price -%}
                          <s class="text-sm text-gray-400 block">{{ item.original_line_price | money }}</s>
                          <span class="text-base font-medium">{{ item.final_line_price | money }}</span>
                        {%- else -%}
                          <span class="text-base font-medium">{{ item.original_line_price | money }}</span>
                        {%- endif -%}
                      </div>
                    </div>
                  </div>
                {%- endfor -%}
              </div>
            {%- endif -%}
            <p id="CartDrawer-LiveRegionText" class="sr-only" role="status"></p>
            <p id="CartDrawer-LineItemStatus" class="sr-only" aria-hidden="true" role="status">
              {{ 'accessibility.loading' | t }}
            </p>
          </div>
          <div id="CartDrawer-CartErrors" role="alert" class="px-6 py-2 text-sm text-red-600"></div>
        </form>
      </cart-drawer-items>
      <div class="px-[20px] mb-[20px]">
        <div class="text-right" role="status">
          <p class="text-base  font-light">
            EST. TOTAL: <span class="font-medium">{{ cart.total_price | money }}</span>
          </p>
          <small class="text-xs text-[#BABABA] font-light"> Final shipping & taxes calculated at checkout. </small>
        </div>
        <!-- Shipping Note -->

        <!-- Total -->
      </div>
      <div class="px-6 pb-4 space-y-3 flex flex-col md:flex-row gap-[20px]">
        <button
          type="submit"
          id="CartDrawer-Checkout"
          class="w-full rounded-[5px] bg-black text-white py-3 px-6 hover:bg-gray-800 transition-colors text-sm tracking-wider font-medium mb-0"
          name="checkout"
          form="CartDrawer-Form"
          {% if cart == empty %}
            disabled
          {% endif %}
        >
          CHECK OUT
        </button>
        <button
          type="button"
          class="w-full rounded-[5px] bg-gray-200 text-black py-3 px-6 hover:bg-gray-300 transition-colors text-sm tracking-wider font-medium"
          onclick="this.closest('cart-drawer').close()"
        >
          CONTINUE SHOPPING
        </button>
      </div>

      <!-- You Might Also Like Section -->
      {%- if settings.cart_drawer_collection != blank -%}
        <div class="border-t border-gray-200 px-6 py-6">
          <h3 class="text-base font-medium tracking-wide mb-4">YOU MIGHT ALSO LIKE...</h3>
          <div class="overflow-x-auto -mx-6 px-6">
            <div class="flex gap-4 pb-2">
              {%- assign collection = settings.cart_drawer_collection -%}
              {%- for product in collection.products limit: 6 -%}
                <div class="shrink-0 w-40">
                  <a href="{{ product.url }}" class="block group">
                    <div class="relative mb-2 bg-gray-100 aspect-3/4">
                      {%- if product.featured_image -%}
                        <img
                          src="{{ product.featured_image | image_url: width: 300 }}"
                          alt="{{ product.featured_image.alt | escape }}"
                          class="w-full h-full object-cover"
                          loading="lazy"
                          width="160"
                          height="213"
                        >
                      {%- endif -%}
                      <button
                        type="button"
                        class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm hover:shadow-md transition-shadow"
                      >
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                      </button>
                    </div>
                    <h4 class="text-sm mb-1 group-hover:opacity-70 transition-opacity">{{ product.title }}</h4>
                    <p class="text-sm font-medium">${{ product.price | money_without_currency }}</p>
                  </a>
                </div>
              {%- endfor -%}
            </div>
          </div>
        </div>
      {%- endif -%}

      <!-- Footer -->
      {% comment %}
        <div class="cart-drawer__footer border-t border-gray-200 bg-white">

        </div>
      {% endcomment %}
    </div>
  </div>
</cart-drawer>

<script>
  // Show success message when item added to cart
  document.addEventListener('DOMContentLoaded', function () {
    const cartDrawer = document.querySelector('cart-drawer');

    if (cartDrawer) {
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const isActive = cartDrawer.classList.contains('active');
            const successMessage = document.getElementById('cart-success-message');

            if (isActive && successMessage) {
              successMessage.classList.remove('hidden');
              setTimeout(function () {
                successMessage.classList.add('hidden');
              }, 3000);
            }
          }
        });
      });

      observer.observe(cartDrawer, {
        attributes: true,
        attributeFilter: ['class'],
      });
    }
  });
</script>
