{% comment %}
  Renders a megamenu for the header.

  Usage:
  {% render 'header-mega-menu', section: section %}
{% endcomment %}

<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline gap-[40px]" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- if link.links != blank -%}
          <header-menu>
            <details id="Details-HeaderMenu-{{ forloop.index }}" class="mega-menu">
              <summary
                id="HeaderMenu-{{ link.handle }}"
                class="header__menu-item list-menu__item link focus-inset uppercase"
              >
                <span
                  {%- if link.child_active %}
                    class="header__active-menu-item "
                  {% endif %}
                >
                  {{- link.title | escape -}}
                </span>
              </summary>
              <div
                id="MegaMenu-Content-{{ forloop.index }}"
                class="mega-menu__content flex  color-{{ section.settings.menu_color_scheme }} gradient motion-reduce global-settings-popup"
                tabindex="-1"
              >
              <div class="w-1/2 aspect-720/440 overflow-hidden mega-menu-image-container" data-menu-index="{{ forloop.index }}" style="position: relative;">
                {%- liquid
                  assign first_link_image = section.settings.desktop_mega_menu_image
                  assign first_link_image = null
                  for block in section.blocks
                    if block.type == 'link_image'
                      for childlink in link.links
                        if block.settings.link == childlink.url
                          assign first_link_image = block.settings.image
                          break
                        endif
                      endfor
                      if first_link_image != null
                        break
                      endif
                    endif
                  endfor
                  if first_link_image == null
                    assign first_link_image = default_image
                  endif
                -%}
                {%- if first_link_image != blank -%}
                  {% render 'alp-responsive-image', image: first_link_image, class: 'mega-menu-image w-full h-full object-cover' %}
                {%- else -%}
                  {% render 'alp-responsive-image', image: default_image, class: 'mega-menu-image w-full h-full object-cover' %}
                {%- endif -%}
              </div>
              <div class=" aspect-720/440 p-8 ">
                 <span class="block mb-[16px] text-sm text-[#BABABA]">Categories:</span>
                <ul
                  class="mega-menu__list columns-2 gap-[16px] {% if link.levels == 1 %} mega-menu__list--condensed{% endif %}"
                  role="list"
                >
              
                  {%- for childlink in link.links -%}
                    {%- liquid
                      assign link_image = null
                      for block in section.blocks
                        if block.type == 'link_image' and block.settings.link == childlink.url
                          assign link_image = block.settings.image
                          break
                        endif
                      endfor
                      if link_image == null
                        assign link_image = section.settings.desktop_mega_menu_image
                      endif
                    -%}
                    <li class="flex break-inside-avoid mb-[16px]">
                      <a
                        id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}"
                        href="{{ childlink.url }}"
                        class="mega-menu__link mega-menu__link--level-2 link{% if childlink.current %} mega-menu__link--active{% endif %}"
                        data-menu-index="{{ forloop.parentloop.index }}"
                        data-image-url="{% if link_image != blank %}{{ link_image | image_url: width: 1440 }}{% endif %}"
                        {% if childlink.current %}
                          aria-current="page"
                        {% endif %}
                      >
                        {{ childlink.title | escape }}
                      </a>
                      {%- if childlink.links != blank -%}
                        <ul class="list-unstyled" role="list">
                          {%- for grandchildlink in childlink.links -%}
                            {%- liquid
                              assign grandchild_image = null
                              for block in section.blocks
                                if block.type == 'link_image' and block.settings.link == grandchildlink.url
                                  assign grandchild_image = block.settings.image
                                  break
                                endif
                              endfor
                              if grandchild_image == null
                                assign grandchild_image = section.settings.desktop_mega_menu_image
                              endif
                            -%}
                            <li>
                              <a
                                id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                                href="{{ grandchildlink.url }}"
                                class="mega-menu__link link{% if grandchildlink.current %} mega-menu__link--active{% endif %}"
                                data-menu-index="{{ forloop.parentloop.parentloop.index }}"
                                data-image-url="{% if grandchild_image != blank %}{{ grandchild_image | image_url: width: 1440 }}{% endif %}"
                                {% if grandchildlink.current %}
                                  aria-current="page"
                                {% endif %}
                              >
                                {{ grandchildlink.title | escape }}
                              </a>
                            </li>
                          {%- endfor -%}
                        </ul>
                      {%- endif -%}
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
              </div>

            </details>
          </header-menu>
        {%- else -%}
          <a
            id="HeaderMenu-{{ link.handle }}"
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset uppercase"
            {% if link.current %}
              aria-current="page"
            {% endif %}
          >
            <span
              {%- if link.current %}
                class="header__active-menu-item"
              {% endif %}
            >
              {{- link.title | escape -}}
            </span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

<script>
  (function() {
    // 处理 mega menu 图片悬停切换
    document.addEventListener('DOMContentLoaded', function() {
      const menuLinks = document.querySelectorAll('.mega-menu__link[data-image-url]');
      
      // 为每个菜单容器存储当前请求的标识
      const pendingRequests = new Map();
      
      menuLinks.forEach(function(link) {
        link.addEventListener('mouseenter', function() {
          const imageUrl = this.getAttribute('data-image-url');
          const menuIndex = this.getAttribute('data-menu-index');
          
          if (!imageUrl || !menuIndex) return;
          
          const imageContainer = document.querySelector(
            `.mega-menu-image-container[data-menu-index="${menuIndex}"]`
          );
          
          if (!imageContainer) return;
          
          const existingPicture = imageContainer.querySelector('picture');
          if (!existingPicture) return;
          
          // 生成当前请求的唯一标识
          const requestId = Date.now() + Math.random();
          pendingRequests.set(menuIndex, requestId);
          
          // 清除容器中所有未完成的图片（除了当前显示的）
          const allPictures = imageContainer.querySelectorAll('picture');
          allPictures.forEach(function(pic) {
            if (pic !== existingPicture && pic.style.position === 'absolute') {
              pic.remove();
            }
          });
          
          // 预加载图片
          const img = new Image();
          img.onload = function() {
            // 检查这个请求是否仍然是最新的
            if (pendingRequests.get(menuIndex) !== requestId) {
              return; // 如果已经有更新的请求，忽略这个
            }
            
            // 再次检查容器中是否还有当前显示的图片
            const currentPicture = imageContainer.querySelector('picture:not([style*="position: absolute"])');
            if (!currentPicture) return;
            
            // 创建新的 picture 元素
            const newPicture = document.createElement('picture');
            const existingStyle = currentPicture.getAttribute('style') || '';
            newPicture.setAttribute('style', existingStyle + ' position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s ease;');
            
            const newSource = document.createElement('source');
            newSource.srcset = imageUrl;
            newSource.setAttribute('media', '(min-width: 768px)');
            
            const newImg = document.createElement('img');
            newImg.src = imageUrl;
            const existingImg = currentPicture.querySelector('img');
            newImg.alt = existingImg ? existingImg.alt : '';
            newImg.loading = 'lazy';
            newImg.width = '100%';
            newImg.height = 'auto';
            newImg.style.cssText = 'max-width: 100%; object-fit: cover; width: 100%; height: 100%;';
            newImg.className = 'mega-menu-image w-full h-full object-cover';
            
            newPicture.appendChild(newSource);
            newPicture.appendChild(newImg);
            
            // 确保现有图片有过渡效果
            if (!currentPicture.style.transition) {
              currentPicture.style.transition = 'opacity 0.3s ease';
            }
            
            // 添加到容器
            imageContainer.appendChild(newPicture);
            
            // 淡入新图片，淡出旧图片
            requestAnimationFrame(function() {
              // 再次检查请求是否仍然有效
              if (pendingRequests.get(menuIndex) !== requestId) {
                newPicture.remove();
                return;
              }
              
              newPicture.style.opacity = '1';
              currentPicture.style.opacity = '0';
              setTimeout(function() {
                // 最后一次检查请求是否仍然有效
                if (pendingRequests.get(menuIndex) !== requestId) {
                  newPicture.remove();
                  return;
                }
                
                if (currentPicture.parentNode) {
                  currentPicture.parentNode.removeChild(currentPicture);
                }
                // 将新图片从 absolute 定位改为正常定位
                newPicture.style.position = '';
                newPicture.style.top = '';
                newPicture.style.left = '';
              }, 300);
            });
          };
          img.src = imageUrl;
        });
      });
    });
  })();
</script>
