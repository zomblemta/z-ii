{% comment %}
  Renders a megamenu for the header.

  Usage:
  {% render 'header-mega-menu', section: section %}
{% endcomment %}

<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline gap-[40px]" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- if link.links != blank -%}
          <header-menu>
            <details id="Details-HeaderMenu-{{ forloop.index }}" class="mega-menu">
                <summary
                  id="HeaderMenu-{{ link.handle }}"
                  class="header__menu-item list-menu__item link focus-inset uppercase"
                >
                  <a
                    href="{{ link.url }}"
                    class="header__menu-link-inline"
                    onclick="event.stopPropagation();"
                  >
                    <span
                      {%- if link.child_active %}
                        class="header__active-menu-item "
                      {% endif %}
                    >
                      {{- link.title | escape -}}
                    </span>
                  </a>
                </summary>

              <div
                id="MegaMenu-Content-{{ forloop.index }}"
                class="mega-menu__content flex  color-{{ section.settings.menu_color_scheme }} gradient motion-reduce global-settings-popup"
                tabindex="-1"
              >
                <div
                  class="w-1/2 aspect-720/440 overflow-hidden mega-menu-image-container"
                  data-menu-index="{{ forloop.index }}"
                  data-default-image="{{ section.settings.desktop_mega_menu_image | image_url: width: 1440 }}"
                  style="position: relative;"
                >
                  {% render 'alp-responsive-image',
                    image: section.settings.desktop_mega_menu_image,
                    class: 'mega-menu-image w-full h-full pr-[2px] object-cover'
                  %}
                </div>
                <div class=" aspect-720/440 p-8 ">
                  <span class="block mb-[16px] text-sm text-[#BABABA]">Categories:</span>
                  <ul
                    class="mega-menu__list grid h-full grid-cols-2 gap-[30px] {% if link.levels == 1 %} mega-menu__list--condensed{% endif %}"
                    role="list"
                  >
                    {%- for childlink in link.links -%}
                      {%- liquid
                        assign link_image = null
                        for block in section.blocks
                          if block.type == 'link_image' and block.settings.link == childlink.url
                            assign link_image = block.settings.image
                            break
                          endif
                        endfor
                        if link_image == null
                          assign link_image = section.settings.desktop_mega_menu_image
                        endif
                      -%}
                      <li class="flex break-inside-avoid mb-[16px]">
                        <a
                          id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}"
                          href="{{ childlink.url }}"
                          class="mega-menu__link mega-menu__link--level-2 link{% if childlink.current %} mega-menu__link--active{% endif %}"
                          data-menu-index="{{ forloop.parentloop.index }}"
                          data-image-url="{% if link_image != blank %}{{ link_image | image_url: width: 1440 }}{% endif %}"
                          {% if childlink.current %}
                            aria-current="page"
                          {% endif %}
                        >
                          {{ childlink.title | escape }}
                        </a>
                        {%- if childlink.links != blank -%}
                          <ul class="list-unstyled" role="list">
                            {%- for grandchildlink in childlink.links -%}
                              {%- liquid
                                assign grandchild_image = null
                                for block in section.blocks
                                  if block.type == 'link_image' and block.settings.link == grandchildlink.url
                                    assign grandchild_image = block.settings.image
                                    break
                                  endif
                                endfor
                                if grandchild_image == null
                                  assign grandchild_image = section.settings.desktop_mega_menu_image
                                endif
                              -%}
                              <li>
                                <a
                                  id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                                  href="{{ grandchildlink.url }}"
                                  class="mega-menu__link link{% if grandchildlink.current %} mega-menu__link--active{% endif %}"
                                  data-menu-index="{{ forloop.parentloop.parentloop.index }}"
                                  data-image-url="{% if grandchild_image != blank %}{{ grandchild_image | image_url: width: 1440 }}{% endif %}"
                                  {% if grandchildlink.current %}
                                    aria-current="page"
                                  {% endif %}
                                >
                                  {{ grandchildlink.title | escape }}
                                </a>
                              </li>
                            {%- endfor -%}
                          </ul>
                        {%- endif -%}
                      </li>
                    {%- endfor -%}
                  </ul>
                </div>
              </div>
            </details>
          </header-menu>
        {%- else -%}
          <a
            id="HeaderMenu-{{ link.handle }}"
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset uppercase"
            {% if link.current %}
              aria-current="page"
            {% endif %}
          >
            <span
              {%- if link.current %}
                class="header__active-menu-item"
              {% endif %}
            >
              {{- link.title | escape -}}
            </span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

<style>
  .header__menu-link-inline {
    display: inline-block;
    text-decoration: none;
    color: inherit;
    width: 100%;
  }
  
  .header__menu-link-inline:hover {
    text-decoration: none;
  }
  
  .header__menu-link-inline span {
    display: inline-block;
  }

  /* 隐藏菜单弹出框的滚动条 */
  .mega-menu__content,
  .mega-menu__content *,
  .mega-menu__list,
  .mega-menu__list * {
    scrollbar-width: none !important; /* Firefox */
    -ms-overflow-style: none !important; /* IE and Edge */
  }
  
  .mega-menu__content::-webkit-scrollbar,
  .mega-menu__content *::-webkit-scrollbar,
  .mega-menu__list::-webkit-scrollbar,
  .mega-menu__list *::-webkit-scrollbar {
    display: none !important; /* Chrome, Safari and Opera */
    width: 0 !important;
    height: 0 !important;
  }
</style>

<script>
  (function () {
    // 处理 mega menu 图片悬停切换
    document.addEventListener('DOMContentLoaded', function () {
      const menuLinks = document.querySelectorAll('.mega-menu__link[data-image-url]');

      menuLinks.forEach(function (link) {
        const menuIndex = link.getAttribute('data-menu-index');

        // 鼠标移入：显示对应图片
        link.addEventListener('mouseenter', function () {
          const imageUrl = this.getAttribute('data-image-url');
          if (!imageUrl || !menuIndex) return;

          const imageContainer = document.querySelector(`.mega-menu-image-container[data-menu-index="${menuIndex}"]`);
          if (!imageContainer) return;

          // 更新 source 和 img
          const source = imageContainer.querySelector('source');
          const img = imageContainer.querySelector('img');
          
          if (source) source.srcset = imageUrl;
          if (img) img.src = imageUrl;
        });

        // 鼠标移出：恢复默认图片
        link.addEventListener('mouseleave', function () {
          const imageContainer = document.querySelector(`.mega-menu-image-container[data-menu-index="${menuIndex}"]`);
          if (!imageContainer) return;

          // 从容器获取默认图片URL
          const defaultImageUrl = imageContainer.getAttribute('data-default-image');
          if (!defaultImageUrl) return;

          // 恢复 source 和 img 为默认图片
          const source = imageContainer.querySelector('source');
          const img = imageContainer.querySelector('img');
          
          if (source) source.srcset = defaultImageUrl;
          if (img) img.src = defaultImageUrl;
        });
      });
    });
  })();
</script>
