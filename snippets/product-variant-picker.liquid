{% comment %}
  Renders product variant-picker

  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} Id of the product form to which the variant picker is associated.
  Usage:
  {% render 'product-variant-picker', product: product, block: block, product_form_id: product_form_id %}
{% endcomment %}

{% assign color_label = 'color,farve,farbe,couleur,cor,color,farve,farbe,couleur,cor,colour,颜色' | split: ',' %}
{% assign size_label = 'size,format,größe,talla,taille,dimension,mărime,dimensione,tamanho,寸法,尺寸' | split: ',' %}

{%- unless product.has_only_default_variant -%}
  <variant-selects
    id="variant-selects-{{ section.id }}"
    data-section="{{ section.id }}"
    class="flex flex-col justify-between md:gap-y-[14px] 2xl:gap-y-[28px] h-full"
    {{ block.shopify_attributes }}
  >
    {%- for option in product.options_with_values -%}
      {% assign option_name_lower = option.name | downcase %}
      {% assign is_color_label = false %}
      {% for color_name in color_label %}
        {% if option_name_lower contains color_name %}
          {% assign is_color_label = true %}
          {% break %}
        {% endif %}
      {% endfor %}

      <fieldset class="js bg-[#F4F4F4] py-[17px] flex-col gap-y-[10px] items-start md:flex-row px-[20px] md:px-[30px] rounded-[5px] product-form__input product-form__input--pill flex justify-start gap-x-[25px] w-full  {% if is_color_label %} product-form__input--color {% else %} product-form__input--size {% endif %}">
        <span class="form__label font-Montaga flex items-center text-nowrap gap-x-1 md:gap-x-2 text-xs md:text-xl font-normal tracking-[1.2px] md:tracking-[1.4px] uppercase text-black">
          <span class="border border-black rounded-full w-[24px] h-[24px] flex items-center justify-center ">
            {{- forloop.index -}}
          </span>
          {{ option.name }}:
          {% comment %}
            {% if is_color_label %}
              <span data-js-color-name class=" w-max-content text-xs md:text-sm font-normal tracking-[1.2px] md:tracking-[1.4px] uppercase text-black">
                {{ option.selected_value | default: option.values.first }}
              </span>
            {% endif %}
          {% endcomment %}
        </span>
        <div class="variant-values flex gap-x-[25px] gap-y-2 w-full flex-wrap">
          {% render 'product-variant-options',
            product: product,
            option: option,
            block: block,
            picker_type: 'button',
            is_color_label: is_color_label
          %}
        </div>
        <span class="variant-values__arrows" aria-hidden="true">
          <svg
            class="variant-values__arrow variant-values__arrow--down"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
          >
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <svg
            class="variant-values__arrow variant-values__arrow--up"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
          >
            <path d="M18 15l-6-6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </fieldset>
    {%- endfor -%}

    <div
      id="Quantity-Form-{{ section.id }}"
      class=" product-form__quantity bg-[#F4F4F4] py-[17px] flex-col gap-y-[10px] items-start md:flex-row px-[20px] md:px-[30px]  rounded-[5px] "
      {{ block.shopify_attributes }}
    >
      {% comment %} TODO: enable theme-check once `item_count_for_variant` is accepted as valid filter {% endcomment %}
      {% # theme-check-disable %}
      <div class="flex flex-col md:flex-row items-start md:items-center gap-x-[10px] gap-y-[8px] 2xl:justify-between w-full">
        {%- assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id -%}
        {% # theme-check-enable %}
        <span class="visually-hidden" id="quantity-label-{{ section.id }}">
          {%- if cart_qty > 0 -%}
            {{- 'products.product.quantity.in_cart_aria_label' | t: quantity: cart_qty -}}
          {%- else -%}
            {{- 'products.product.quantity.label' | t -}}
          {%- endif -%}
        </span>
        <label
          class="quantity__label font-Montaga flex items-center text-nowrap gap-x-1 md:gap-x-2 text-xs md:text-xl font-normal tracking-[1.2px] md:tracking-[1.4px]  text-black "
          for="Quantity-{{ section.id }}"
          aria-labelledby="quantity-label-{{ section.id }}"
        >
          <span class="border border-black rounded-full w-[24px] h-[24px] flex items-center justify-center ">
            {{- 3 -}}
          </span>
          <span aria-hidden="true">{{ 'products.product.quantity.label' | t }}:</span>

          <span class="text-xs md:text-sm text-[#999] font-light -mr-4 md:hidden "
          >( Min. quantity:
          {{
            product.metafields.custom.min_quantity
            | default: product.selected_or_first_available_variant.quantity_rule.min
          }}
          )
        </span>
        </label>
     
        <div class="price-per-item__container">
          <quantity-input
            class="quantity-input--inside h-[36px] flex"
            data-url="{{ product.url }}"
            data-section="{{ section.id }}"
          >
            <button class="quantity__button" name="minus" type="button">
              <span class="visually-hidden">
                {{- 'products.product.quantity.decrease' | t: product: product.title | escape -}}
              </span>
              <span class="svg-wrapper">
                {{- 'icon-minus.svg' | inline_asset_content -}}
              </span>
            </button>
            <input
              class="underline h-full rounded-[5px] text-center px-[12px] md:px-[24px] py-[6px] text-lg md:text-[24px] font-Montaga bg-white w-auto min-w-[60px] max-w-[108px] md:max-w-[140px]"
              type="number"
              name="quantity"
              id="Quantity-{{ section.id }}"
              data-cart-quantity="{{ cart_qty }}"
              data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
              min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
           
              step="{{ product.selected_or_first_available_variant.quantity_rule.increment }}"
              value="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
              form="{{ product_form_id }}"
            >
            <button class="quantity__button" name="plus" type="button">
              <span class="visually-hidden">
                {{- 'products.product.quantity.increase' | t: product: product.title | escape -}}
              </span>
              <span class="svg-wrapper">
                {{- 'icon-plus.svg' | inline_asset_content -}}
              </span>
            </button>
          </quantity-input>
          {%- liquid
            assign volume_pricing_array = product.selected_or_first_available_variant.quantity_price_breaks | sort: 'quantity' | reverse
            assign current_qty_for_volume_pricing = cart_qty | plus: product.selected_or_first_available_variant.quantity_rule.min
            if cart_qty > 0
              assign current_qty_for_volume_pricing = cart_qty | plus: product.selected_or_first_available_variant.quantity_rule.increment
            endif
          -%}
          {%- if product.quantity_price_breaks_configured? -%}
            <price-per-item
              id="Price-Per-Item-{{ section.id }}"
              data-section-id="{{ section.id }}"
              data-variant-id="{{ product.selected_or_first_available_variant.id }}"
            >
              {%- if product.selected_or_first_available_variant.quantity_price_breaks.size > 0 -%}
                {%- assign variant_price_compare = product.selected_or_first_available_variant.compare_at_price -%}
                <div class="price-per-item">
                  {%- if variant_price_compare -%}
                    <dl class="price-per-item--current">
                      <dt class="visually-hidden">
                        {{ 'products.product.price.regular_price' | t }}
                      </dt>
                      <dd>
                        <s class="variant-item__old-price">
                          {{ variant_price_compare | money_with_currency }}
                        </s>
                      </dd>
                    </dl>
                  {%- endif -%}
                  {%- if current_qty_for_volume_pricing < volume_pricing_array.last.minimum_quantity -%}
                    {%- assign variant_price = product.selected_or_first_available_variant.price
                      | money_with_currency
                    -%}
                    <span class="price-per-item--current">
                      {{- 'products.product.volume_pricing.price_at_each_html' | t: price: variant_price -}}
                    </span>
                  {%- else -%}
                    {%- for price_break in volume_pricing_array -%}
                      {%- if current_qty_for_volume_pricing >= price_break.minimum_quantity -%}
                        {%- assign price_break_price = price_break.price | money_with_currency -%}
                        <span class="price-per-item--current">
                          {{- 'products.product.volume_pricing.price_at_each_html' | t: price: price_break_price -}}
                        </span>
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                </div>
              {%- else -%}
                {%- assign variant_price = product.selected_or_first_available_variant.price | money_with_currency -%}
                {%- assign variant_price_compare = product.selected_or_first_available_variant.compare_at_price -%}
                <div class="price-per-item">
                  {%- if variant_price_compare -%}
                    <dl class="price-per-item--current">
                      <dt class="visually-hidden">
                        {{ 'products.product.price.regular_price' | t }}
                      </dt>
                      <dd>
                        <s class="variant-item__old-price">
                          {{ variant_price_compare | money_with_currency }}
                        </s>
                      </dd>
                      <dt class="visually-hidden">
                        {{ 'products.product.price.sale_price' | t }}
                      </dt>
                      <dd>
                        <span class="price-per-item--current">
                          {{- 'products.product.volume_pricing.price_at_each_html' | t: price: variant_price -}}
                        </span>
                      </dd>
                    </dl>
                  {%- else -%}
                    <span class="price-per-item--current">
                      {{- 'products.product.volume_pricing.price_at_each_html' | t: price: variant_price -}}
                    </span>
                  {%- endif -%}
                </div>
              {%- endif -%}
            </price-per-item>
          {%- endif -%}
        </div>
        <span class="text-xs md:text-sm text-[#999] font-light -mr-4 hidden md:block "
          >( Min. quantity:
          {{
            product.metafields.custom.min_quantity
            | default: product.selected_or_first_available_variant.quantity_rule.min
          }}
          )
        </span>
      </div>

      <div class="quantity__rules caption" id="Quantity-Rules-{{ section.id }}">
        {%- if product.selected_or_first_available_variant.quantity_rule.increment > 1 -%}
          <span class="divider">
            {{-
              'products.product.quantity.multiples_of'
              | t: quantity: product.selected_or_first_available_variant.quantity_rule.increment
            -}}
          </span>
        {%- endif -%}
        {%- if product.selected_or_first_available_variant.quantity_rule.min > 1 -%}
          <span class="divider">
            {{-
              'products.product.quantity.minimum_of'
              | t: quantity: product.selected_or_first_available_variant.quantity_rule.min
            -}}
          </span>
        {%- endif -%}
        {%- if product.selected_or_first_available_variant.quantity_rule.max != null -%}
          <span class="divider">
            {{-
              'products.product.quantity.maximum_of'
              | t: quantity: product.selected_or_first_available_variant.quantity_rule.max
            -}}
          </span>
        {%- endif -%}
      </div>
      {%- if product.quantity_price_breaks_configured? -%}
        <volume-pricing class="parent-display" id="Volume-{{ section.id }}">
          {%- if product.selected_or_first_available_variant.quantity_price_breaks.size > 0 -%}
            <span class="caption-large">{{ 'products.product.volume_pricing.title' | t }}</span>
            <ul class="list-unstyled">
              <li>
                <span>{{ product.selected_or_first_available_variant.quantity_rule.min }}+</span>
                {%- assign price = product.selected_or_first_available_variant.price | money_with_currency -%}
                <span data-text="{{ 'products.product.volume_pricing.price_at_each_html' | t: price: variant_price }}">
                  {{- 'sections.quick_order_list.each' | t: money: price -}}
                </span>
              </li>
              {%- for price_break in product.selected_or_first_available_variant.quantity_price_breaks -%}
                {%- assign price_break_price = price_break.price | money_with_currency -%}
                <li class="{%- if forloop.index >= 3 -%}show-more-item hidden{%- endif -%}">
                  <span>
                    {{- price_break.minimum_quantity -}}
                    <span aria-hidden="true">+</span></span
                  >
                  <span data-text="{{ 'products.product.volume_pricing.price_at_each_html' | t: price: price_break_price }}">
                    {{- 'sections.quick_order_list.each' | t: money: price_break_price -}}
                  </span>
                </li>
              {%- endfor -%}
            </ul>
            {%- if product.selected_or_first_available_variant.quantity_price_breaks.size >= 3 -%}
              <show-more-button>
                <button
                  class="button-show-more link underlined-link"
                  id="Show-More-{{ section.id }}"
                  type="button"
                >
                  <span class="label-show-more label-text"
                    ><span aria-hidden="true">+ </span>{{ 'products.facets.show_more' | t }}
                  </span>
                </button>
              </show-more-button>
            {%- endif -%}
          {%- endif -%}
        </volume-pricing>
      {%- endif -%}
    </div>

    <script type="application/json" data-selected-variant>
      {{ product.selected_or_first_available_variant | json }}
    </script>

    <script>
      (() => {
        const root = document.getElementById('variant-selects-{{ section.id }}');
        if (!root) return;

        const updateOne = (fieldset) => {
          const values = fieldset.querySelector('.variant-values');
          const arrows = fieldset.querySelector('.variant-values__arrows');
          if (!values || !arrows) return;

          const labels = values.querySelectorAll('label');
          if (!labels || labels.length < 2) {
            fieldset.classList.remove('variant-values--collapsible');
            values.classList.remove('variant-values--clip-enabled');
            return;
          }

          const baseTop = labels[0].offsetTop;
          let wrapped = false;
          for (let i = 1; i < labels.length; i++) {
            if (labels[i].offsetTop > baseTop + 1) {
              wrapped = true;
              break;
            }
          }

          fieldset.classList.toggle('variant-values--collapsible', wrapped);
          values.classList.toggle('variant-values--clip-enabled', wrapped);

          // 记录完整高度，供 CSS 折叠为一半高度使用
          if (wrapped) {
            const fullHeight = values.scrollHeight || 0;
            if (fullHeight > 0) {
              values.style.setProperty('--variant-values-full-height', fullHeight + 'px');
            }
          } else {
            values.style.removeProperty('--variant-values-full-height');
          }
        };

        const updateAll = () => {
          root.querySelectorAll('fieldset.product-form__input').forEach(updateOne);
        };

        let raf = 0;
        const schedule = () => {
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(updateAll);
        };

        // 首次渲染后计算一次
        schedule();
        // 屏幕尺寸变化可能导致换行变化
        window.addEventListener('resize', schedule, { passive: true });
        // 变体切换可能导致 DOM 更新（安全起见再算一次）
        root.addEventListener('change', schedule);
      })();
    </script>
  </variant-selects>
{%- endunless -%}
